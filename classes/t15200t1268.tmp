//************************************************************************************************************
// Name             : Orion_OppManagmentUtility.cls
// Description      : This class has all the processing needed for auto approval process and product validation
//                    This class is created as part of Orion Phase 2 Project CR-00138210 and CR-00138211
// Created By       : Yoganand Gadekar.
// Created Date     : 07/03/2016

/************************Version Updates********************************************************************
26/Aug/2016       Hem    Changes for CR-00140589
26/Aug/2016       Vijit  Changes for CR-00140797
 ***********************************************************************************************************/
public class Orion_OppManagementUtility {

Public static string SIR_Fallout_Reason = 'SIR_Fallout_Reason';
Public static string NoCustomerFound = 'NoCustomerFound';
Public static string multiplecustomerfound = 'multiplecustomerfound';
Public static string opcspfflagcheck = 'opcspfflagcheck';
Public static string opcflagChecked = 'opcflagChecked';
Public static string noneglishinform = 'noneglishinform';
Public static string MSORecordTypeId = 'MSORecordTypeId';
Public static string manualdetermination = 'manualdetermination';
Public static string noopenopportunity = 'noopenopportunity';
Public static string bypassapprovalstatuses= 'bypassapprovalstatuses';
Public static string PendingAssignmentUserId = 'PendingAssignmentUserId';
Public static string DealDenialReason = 'DealDenialReason';
Public static string Approve = 'Approve';
Public static string Auto_approved = 'Auto approved';
Public static string Registration_Products = 'Registration Products';
Public static string Registrations = 'Registrations';
Public static string Deal_Registration = 'Deal Registration';
Public static string SFA_Acc_EC = 'SFA_Acc_EC';
Public static string PSO = 'PSO';
Public static string Reject = 'Reject';
Public static string Auto_rejected = 'Auto rejected';
Public static string Other = (Orion_Phase_II_Configurations__c.getInstance('reasonforreject')!=null && Orion_Phase_II_Configurations__c.getInstance('reasonforreject').value__c!=null && Orion_Phase_II_Configurations__c.getInstance('reasonforreject').value__c!='')?Orion_Phase_II_Configurations__c.getInstance('reasonforreject').value__c:'The opportunity is already in VMwareâ€™s pipeline.';//'Other'; modified as part of Orion Hotfix 05th Auguts
Public Static Id dealRegId;
Public static List<String> dealRegProducts;
Public Static boolean dealRegInAutoApproval = false;
//Public Static String emailSubject = Orion_Phase_II_Configurations__c.getValues('partnerEmailSubject').value__c;
//Public Static String usersEmailId;
//Public Static String emailTemplateBody;
Public static boolean eligibleToLeadService = false;
//Public static string emailToPartnerBody = 'All the products added on Registration were approved';
//Public static string emailToPartnerSub = Orion_Phase_II_Configurations__c.getValues('partnerEmailSubject').value__c;
Public static string accPbmUserName;
Public static string allApprovedProductNames;
Public static boolean allowOppUpdateCheck = true;
public static boolean AprovalfirstRun =true;
Public static boolean acrDealApproval = false;
Public static boolean dealRegProgramUpdate = false;
Public static string dealRegStatus;
Public static string resubmitApprovedPro;
Public static string resubmitRejectedPro;
Public static string manualRuleReason;
Public static List<partner_select_product__c> rejectedProList;//= New Map<id,id>();
Public static boolean leadupdateRecursiveCheck = true;
Public static Id oppOwnerId;
public static boolean sendEmailToOnOppCreate = false;
Public static string accountISREmail;
Public static Id accSourcedOnCustomerName;
Public static Id sourcedConId;
Public static boolean dealManualDeterCheck = false;
public static boolean multipleAccountFlag = false;    //Added as part of CR-00140795 on 26/Aug/2016 - Vijit
Public static string stageNameQua = (Orion_Phase_II_Configurations__c.getInstance('stageNameQua')!=null && Orion_Phase_II_Configurations__c.getInstance('stageNameQua').value__c!=null && Orion_Phase_II_Configurations__c.getInstance('stageNameQua').value__c!='')?Orion_Phase_II_Configurations__c.getInstance('stageNameQua').value__c:'02 - Qualified';//'Other'; modified as part of Orion Hotfix 05th Auguts
Public static id accRecordTypeID = Record_Type_Settings__c.getall().get('SFA_Acc_EC').Record_Type_ID__c;//added as part of 26th August Release  
 
  Public static void searchAccount(Deal_Registration__c dealRegRec,string accId){
     String NameAcc = dealRegRec.Company__c;
     string CountryAcc = dealRegRec.country__c;
     string CityAcc = dealRegRec.city__c;
     string ZipCodeAcc = dealRegRec.Zip_Postal_Code__c;
     string StateAcc = dealRegRec.State_Province__c;
     string domainAcc = dealRegRec.Orion_Customer_Domain__c;
     //added as part of 26th August Release - start
        string domainNames = (Orion_Phase_II_Configurations__c.getInstance('domainNames')!=null && Orion_Phase_II_Configurations__c.getInstance('domainNames').value__c!=null && Orion_Phase_II_Configurations__c.getInstance('domainNames').value__c!='')?Orion_Phase_II_Configurations__c.getInstance('domainNames').value__c:'www.,http://www.,https://www.';//'Other'; modified as part of Orion Hotfix 05th Auguts
        List<string> domainNameList = new List<string>();        
            domainNameList.add(domainAcc);
        
        for(string str : domainNames.split(',')){
            if(domainAcc != null && domainAcc != '')
                domainAcc = domainAcc.removeStartIgnoreCase(str);
        }        
        for(string str : domainNames.split(',')){
            if(str != null && str != '')    
                domainNameList.add(str+domainAcc);
        }
        if(domainAcc!= null && domainAcc!= ''){
            domainNameList.add(domainAcc);
        }    
     //added as part of 26th August Release - end
                 
     List<account> accList = New List<account>();
     //added as part of 26th August start
     List<account> accDomList = New List<account>();
     List<account> accNameList = New List<account>();
     List<account> accFormList = New List<account>();
     Boolean putDealInAuto = false;
     string noSingleAccount = (Orion_Phase_II_Configurations__c.getInstance('nosingleaccount')!=null && Orion_Phase_II_Configurations__c.getInstance('nosingleaccount').value__c!=null && Orion_Phase_II_Configurations__c.getInstance('nosingleaccount').value__c!='')?Orion_Phase_II_Configurations__c.getInstance('nosingleaccount').value__c:'No Single account was found';
     Boolean putdealInACR = false;
     string multiAccount = (Orion_Phase_II_Configurations__c.getInstance('multiAccount')!=null && Orion_Phase_II_Configurations__c.getInstance('multiAccount').value__c!=null && Orion_Phase_II_Configurations__c.getInstance('multiAccount').value__c!='')?Orion_Phase_II_Configurations__c.getInstance('multiAccount').value__c:'Multiple accounts found for the entered email address.';     //Added as part of CR-00140795 on 26/Aug/2016 - Vijit
     //added as part of 26th August end
     
     List<deal_Registration__c> dealList = New List<deal_registration__c>();
     dealList.add(dealRegRec);
      rejectedProList = New List<partner_select_product__c>();
        eligibleToLeadService = dealRegRec.Orion_Eligible_to_Lead_Services__c;
        dealRegStatus = dealRegRec.Registration_Status__c;
                
     //use the account found on registration form for product valdiation
     if(accId != null){
       accFormList = database.query(Orion_OppManagementSequenceController.buildQueryString(false,true,false)+' where Id = \''+accId+'\' limit 1');
     }
     //Do account search if account was not found on registration form
     //else {
         //Added by HEM on 26th-Aug-2016 - CR-00140589 - START
         List<String> excludePFSTList = new List<String>();
         excludePFSTList = Orion_Record__c.getInstance('PFSTNames')!=null && Orion_Record__                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              